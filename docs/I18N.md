# Localisation & Internationalisation (i18n)

## Overview

KaabaTrip must adapt to the user's location and language. The app should feel native whether the user is in London, Paris, or Dubai.

---

## 1. Supported languages

| Language | Code | Direction | Default for |
|----------|------|-----------|-------------|
| English | `en` | LTR | UK, US, CA |
| French | `fr` | LTR | France, francophone Africa |
| Arabic | `ar` | RTL | UAE, Saudi Arabia, MENA |

**Default:** English. Auto-detected from `navigator.language`. User can override via language switcher in the header.

**Language switcher requirements:**
- Visible in the header on all pages.
- Persists choice to `localStorage` key `kb_language` (values: `en`, `fr`, `ar`).
- On change: re-renders all translated strings. No page reload required (client-side switch).
- Shows language names in their own script: "English", "Fran\u00e7ais", "\u0627\u0644\u0639\u0631\u0628\u064a\u0629".

---

## 2. RTL support (Arabic)

When language is `ar`:
- `<html dir="rtl" lang="ar">` is set.
- CSS uses logical properties (`margin-inline-start` not `margin-left`).
- Flexbox/grid layouts reverse naturally via `dir="rtl"`.
- Icons that imply direction (arrows, chevrons) are mirrored.
- Text alignment follows `dir` (no hardcoded `text-left`).

**Implementation approach:**
- Use Tailwind's `rtl:` variant where needed.
- Set `dir` attribute on `<html>` based on active language.
- Avoid hardcoded `left`/`right` in CSS. Use `start`/`end` equivalents.

---

## 3. Currency & pricing

### Detection logic (already exists in `lib/i18n/region.ts`)

| Signal | Region | Currency | Distance |
|--------|--------|----------|----------|
| `en-GB` locale | UK | GBP (\u00a3) | miles |
| `fr-*` locale | EU | EUR (\u20ac) | km |
| `en-US` locale | US | USD ($) | miles |
| `en-CA` locale | CA | CAD (C$) | km |
| `ar-AE` locale or Dubai/Abu Dhabi timezone | UAE | AED | km |
| Fallback | UK | GBP | miles |

### How prices are displayed

1. Package data is stored in the operator's currency (field: `currency`, e.g. `"GBP"`).
2. On display, `formatPriceForRegion()` from `lib/i18n/format.ts` converts to the user's local currency using static exchange rates.
3. If conversion is not possible (unknown currency pair), show the original currency.
4. Always show the conversion note: e.g. "\u00a31,200" or "\u20ac1,404 (approx)".
5. `Intl.NumberFormat` handles locale-specific formatting (comma vs dot, symbol placement).

### Exchange rates

Currently hardcoded in `lib/i18n/format.ts` as `GBP_RATES`. This is acceptable for MVP. Future: fetch rates from an API daily.

| From | To | Rate |
|------|----|------|
| GBP | USD | 1.27 |
| GBP | EUR | 1.17 |
| GBP | CAD | 1.72 |
| GBP | AED | 4.67 |

---

## 4. Location-aware results

### What "location-aware" means

When a UK user searches for packages:
- **Airports:** Show UK departure airports (LHR, MAN, BHX, etc.).
- **Flights:** Show routes from UK airports.
- **Operators:** Prioritise UK-based operators (but show all).
- **Currency:** Prices in GBP.

When a French user searches:
- **Airports:** CDG, ORY, LYS, MRS, etc.
- **Flights:** Routes from French airports.
- **Currency:** Prices in EUR.

When a UAE user searches:
- **Airports:** DXB, AUH, SHJ.
- **Currency:** Prices in AED.

### Implementation plan

**Phase 1 (now):** Currency detection + conversion + formatting. Already built.

**Phase 2 (next):** Add `departureRegion` to search params. Filter packages by departure airports matching the user's region. Operators tag packages with supported departure airports.

**Phase 3 (future):** Operator profiles include `servingRegions`. Search results prioritise operators serving the user's region.

---

## 5. Translation architecture

### Approach: JSON translation files

```
lib/i18n/
  region.ts          # Region detection (exists)
  format.ts          # Currency/distance formatting (exists)
  translations/
    en.json          # English strings
    fr.json          # French strings
    ar.json          # Arabic strings
  use-translation.ts # React hook: useTranslation()
```

### Translation file format

```json
{
  "nav.getQuote": "Get a Quote",
  "nav.operatorDashboard": "Operator Dashboard",
  "hero.searchBest": "Search Best Packages for:",
  "hero.hajj": "HAJJ",
  "hero.umrah": "UMRAH",
  "search.found": "Found {{count}} amazing packages for your journey",
  "search.filter": "Filter",
  "search.sort": "Sort",
  "search.shortlistOnly": "Shortlist only",
  "search.inShortlist": "{{count}} in shortlist",
  "search.compare": "Compare ({{count}})",
  "search.addToShortlist": "Add to Shortlist",
  "search.shortlisted": "Shortlisted",
  "search.addToCompare": "Add to Compare",
  "search.addedForComparison": "Added for comparison",
  "search.seeFullDetail": "See full package detail",
  "compare.title": "Compare Packages",
  "compare.feature": "Feature",
  "compare.price": "Price",
  "compare.operator": "Operator",
  "compare.totalNights": "Total Nights",
  "compare.hotelRating": "Hotel Rating",
  "compare.distance": "Distance to Haram",
  "compare.inclusions": "Inclusions",
  "common.close": "Close",
  "common.notProvided": "Not provided",
  "error.somethingWrong": "Something went wrong",
  "error.tryAgain": "Try again",
  "error.pageNotFound": "Page not found",
  "error.goHome": "Go home"
}
```

### `useTranslation()` hook

```typescript
// Usage in components:
const { t } = useTranslation();
return <h1>{t('hero.searchBest')}</h1>;

// With interpolation:
return <p>{t('search.found', { count: packages.length })}</p>;
```

### Rules for translation strings

1. **Keys use dot notation:** `section.label` (e.g. `search.filter`).
2. **Never hardcode user-facing text.** All visible strings must go through `t()`.
3. **Interpolation uses `{{variable}}` syntax.**
4. **Pluralisation:** Use `count` variable. Add `_one` / `_other` suffixes if needed.
5. **Do not translate:** data-testid values, CSS class names, route paths, query param names.
6. **Arabic translations must be reviewed** by a native speaker before release.

---

## 6. Files that need i18n changes

| File | What to change |
|------|---------------|
| `app/layout.tsx` | Set `lang` and `dir` attributes on `<html>` based on active language |
| `components/layout/Header.tsx` | Add language switcher; translate nav labels |
| `components/marketing/Hero.tsx` | Translate CTA text |
| `components/umrah/UmrahSearchForm.tsx` | Translate form labels, placeholders, button text |
| `components/search/PackageList.tsx` | Translate header text, button labels, counts |
| `components/search/PackageCard.tsx` | Translate action buttons |
| `components/request/ComparisonTable.tsx` | Translate feature labels, "Not provided" |
| `app/error.tsx` | Translate error message and button |
| `app/not-found.tsx` | Translate heading and link |
| `lib/comparison.ts` | Replace hardcoded "Not provided" with translation key |

---

## 7. Testing localisation

### Unit tests

- Test `detectRegion()` with various locale/timezone combinations.
- Test `formatPriceForRegion()` for each supported currency.
- Test `convertCurrency()` round-trips.

### Manual checks

- Switch to French: verify all visible text is in French, currency is EUR.
- Switch to Arabic: verify RTL layout, all text in Arabic, currency is AED.
- Verify language persists on refresh (`kb_language` in localStorage).

### E2E

- Future: add a Playwright test that sets locale to `fr-FR` and verifies French text appears.

---

## 8. Migration checklist for existing hardcoded strings

When implementing translations, work through the app page by page:

1. `/` (landing) — Hero CTAs, header nav
2. `/umrah` — Form labels, buttons, quick picks
3. `/search/packages` — Results header, filters, sort, shortlist, compare
4. `/packages/[slug]` — Detail labels
5. Error pages — Messages, buttons
6. Operator pages (later) — Dashboard, forms, analytics

Each page is one micro-task. Test after each.
